 <div class="col-md-3">
        <a href="#myModal" data-toggle="modal" class="btn btn-compose"><i class="fa fa-pencil-square-o"
                aria-hidden="true"></i>Nuevo mensaje</a>

        <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal"
            class="modal fade" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                        <h4 class="modal-title">Enviar mensaje</h4>
                    </div>
                    <div class="modal-body">
                        <div role="form" class="form-horizontal">
                            <div class="form-group">
                                <label class="col-lg-2 control-label">Para</label>
                                <div class="col-lg-10">
                                    <div class="input-group">
                                        <input type="text" data-role="tagsinput" id="destinatarios"
                                            class="form-control">
                                        <span class="input-group-btn">
                                            <a class="btn btn-primary" href="#modalBuscarDestinatarios"
                                                data-toggle="modal"><i class="fa fa-search"></i></a>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-lg-2 control-label">Asunto</label>
                                <div class="col-lg-10">
                                    <input type="text" placeholder="" id="subject" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-lg-2 control-label">Mensaje</label>
                                <div class="col-lg-10">
                                    <textarea rows="5" cols="30" class="form-control" id="body" name=""></textarea>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-lg-offset-2 col-lg-10">

                                    <button class="btn btn-send" onclick="submit();"><i class="fa fa-paper-plane"
                                            aria-hidden="true"></i>Enviar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="modalBuscarDestinatarios"
            class="modal fade" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                        <h4 class="modal-title">Destinatarios</h4>
                    </div>
                    <div class="modal-body">
                        <p>Escribe el nombre de algún usuario para comenzar la búsqueda:
                        </p>
                        <input class="form-control" id="myInput" type="text" placeholder="Buscar..">
                        <br>
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Id</th>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                </tr>
                            </thead>
                            <tbody id="tablaUsuarios">

                            </tbody>
                        </table>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <div class="box box-solid">
            <div class="box-header with-border">
                <h3 class="box-title">Bandejas</h3>

                <div class="box-tools">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="box-body no-padding">
                <ul class="nav nav-pills nav-stacked">
                    <li class="active"><a href="/dashboard/mail/inbox"><i class="fa fa-inbox"></i> Recibidos
                            <span class="label label-primary pull-right">{{recibidos.length}}</span></a></li>
                    <li><a href="/dashboard/mail/enviados"><i class="fa fa-envelope-o"></i> Enviados</a></li>
                    <li><a href="#"><i class="fa fa-file-text-o"></i> Borradores</a></li>

                    <li><a href="#"><i class="fa fa-trash-o"></i> Papelera</a></li>
                </ul>
            </div>
            <!-- /.box-body -->
        </div>
        <!-- /. box -->

        <!-- /.box -->
    </div>

    <script>
    let listaUsuarios = []
    let listaUsuariosSeleccionados = []
    $(document).ready(function () {
        $("#myInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            if (value === null || value.trim().length == 0) {
                $('#tablaUsuarios').empty()
                return
            }

            $.ajax({
                type: "POST",
                url: "/dashboard/mail/findUsersLikeName",
                data: { name: value },
                success: (res) => {
                    listaUsuarios = res
                    $('#tablaUsuarios').empty()

                    $(res).each(function (index, item) {
                        $('#tablaUsuarios').append(
                            `<tr><td><label><input type="checkbox" id="${item.Id}" onclick="checkedChanged(this);"></label>` +
                            '</td><td>' + item.Id +
                            '</td><td>' + item.Username +
                            '</td><td>' + item.Name +
                            '</td></tr>'
                        )

                    });
                },
                dataType: 'json'
            })
        });
    });

    function checkedChanged(ele) {
        if (!ele.checked) return
        let found = listaUsuarios.filter(x => x.Id == ele.id)
        for (let f of found) {
            if (listaUsuariosSeleccionados.filter(x => x.Id == f.Id).length == 0) {
                listaUsuariosSeleccionados.push(f)
            }
        }

        $('#destinatarios').tagsinput('removeAll')

        if (listaUsuariosSeleccionados.length == 0) {
            return
        }

        let destinatarios = []
        for (let f of listaUsuariosSeleccionados) {
            destinatarios.push(f.Username)
        }
        destinatarios.forEach(x => {
            $('#destinatarios').tagsinput('add', x)
        })
    }

    function submit() {
        var items = $('#destinatarios').tagsinput('items')
        if (items.length == 0) {
            alert('Selecciona algún destinatario')
            return
        }

        $.ajax({
            type: "POST",
            url: "/dashboard/mail/findNotExistingUsers",
            data: { 'users': JSON.stringify(items) },
            success: (res) => {
                if (res.length == 0) {
                    $.ajax({
                        type: "POST",
                        url: "/dashboard/mail/sendMail",
                        data: {
                            'users': JSON.stringify(items),
                            'subject': $('#subject').val(),
                            'body': $('#body').val(),
                        },
                        success: (res) => {
                            if (res) {
                                $('#myModal').modal('hide');
                                location.reload()
                            }
                        },
                        dataType: 'json'
                    })
                }
                else {
                    let not_exist = ""
                    for (let item of res) {
                        not_exist += item.Username + "\n"
                    }
                    alert("Los siguientes usuarios no existen\n" + not_exist)
                }
            },
            dataType: 'json'
        })
    }
</script>


<style>
    .btn-compose {
        background: none repeat scroll 0 0 #ff6c60;
        color: #fff;
        padding: 12px 0;
        text-align: center;
        width: 100%;
    }

    .btn-compose:hover {
        background: none repeat scroll 0 0 #f5675c;
        color: #fff;
    }

    .btn-send,
    .btn-send:hover {
        background: none repeat scroll 0 0 #00a8b3;
        color: #fff;
    }

    .btn-send:hover {
        background: none repeat scroll 0 0 #009da7;
    }

    .bootstrap-tagsinput {
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        display: block;
        padding: 4px 6px;
        color: #555;
        vertical-align: middle;
        max-width: 100%;
        line-height: 22px;
        cursor: text;
    }

    .bootstrap-tagsinput input {
        border: none;
        box-shadow: none;
        outline: none;
        background-color: transparent;
        padding: 0 6px;
        margin: 0;
        width: auto;
        max-width: inherit;
    }
</style>